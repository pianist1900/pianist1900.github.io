<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    
    <meta property="og:site_name" content="龚说龚有理">
    <meta property="og:type" content="article">

    
    <meta property="og:image" content="/img/home-notes-bg.jpeg">
    <meta property="twitter:image" content="/img/home-notes-bg.jpeg" />
    

    
    <meta name="title" content="python学习｜文件处理(pandas进阶)" />
    <meta property="og:title" content="python学习｜文件处理(pandas进阶)" />
    <meta property="twitter:title" content="python学习｜文件处理(pandas进阶)" />
    

    
    <meta name="description" content="系统性讲解python的数据读取，为后续分析提供支撑">
    <meta property="og:description" content="系统性讲解python的数据读取，为后续分析提供支撑" />
    <meta property="twitter:description" content="系统性讲解python的数据读取，为后续分析提供支撑" />
    

    <meta property="og:url" content="https://pianist1900.github.io/atmosphere/2025-10-22-nt-pycs-file-handling3/" />

    
    <meta property="twitter:card" content="summary" />
    
    

    <meta name="keyword"  content="Will Gong, 龚元均, Will Gong Blog, 博客, 个人网站, 互联网, 大气化学, 数据分析">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>python学习｜文件处理(pandas进阶) | Gong&#39;s Blog</title>

    <link rel="canonical" href="/atmosphere/2025-10-22-nt-pycs-file-handling3/">

    

    
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    
    <link rel="stylesheet" href="/css/hugo-theme-cleanwhite.min.css">

    
    <link rel="stylesheet" href="/css/zanshang.min.css">

    
    <link rel="stylesheet" href="/css/font-awesome.all.min.css">

    
    <link rel="stylesheet" href="https://pianist1900.github.io/css/hidden-hero-title.css">

    
    <script src="/js/jquery.min.js"></script>

    
    <script src="/js/bootstrap.min.js"></script>

    
    <script src="/js/hux-blog.min.js"></script>

    
    <script src="/js/lazysizes.min.js"></script>

    
    

</head>





<nav class="navbar navbar-default navbar-custom navbar-fixed-top">

    <div class="container-fluid">
        
        <div class="navbar-header page-scroll">
            <button type="button" class="navbar-toggle">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">龚说龚有理</a>
        </div>

        
        
        <div id="huxblog_navbar">
            <div class="navbar-collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="/">All Posts</a>
                    </li>
                    
                        
                    
                    
		    
                        <li><a href="/atmosphere//">ATMOSPHERE</a></li>
                    
                        <li><a href="/reading//">READING</a></li>
                    
                        <li><a href="/notes//">NOTES</a></li>
                    
                        <li><a href="/about//">ABOUT</a></li>
                    
		            <li>
                        <a href="/search"><i class="fa fa-search"></i></a>
		           </li>
                </ul>
            </div>
        </div>
        
    </div>
    
</nav>
<script>
    
    
    
    var $body   = document.body;
    var $toggle = document.querySelector('.navbar-toggle');
    var $navbar = document.querySelector('#huxblog_navbar');
    var $collapse = document.querySelector('.navbar-collapse');

    $toggle.addEventListener('click', handleMagic)
    function handleMagic(e){
        if ($navbar.className.indexOf('in') > 0) {
        
            $navbar.className = " ";
            
            setTimeout(function(){
                
                if($navbar.className.indexOf('in') < 0) {
                    $collapse.style.height = "0px"
                }
            },400)
        }else{
        
            $collapse.style.height = "auto"
            $navbar.className += " in";
        }
    }
</script>




<style type="text/css">
    header.intro-header {
        background-image: url('/img/home-notes-bg.jpeg')
    }
</style>

<header class="intro-header" >

    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>python学习｜文件处理(pandas进阶)</h1>
                    <h2 class="subheading">千里之行始于足下</h2>
                    <span class="meta">
                        
                            Posted by 
                            
                                Will Gong
                             
                            on 
                            Wednesday, October 22, 2025
                            
                            
                            
                            
                    </span>
                </div>
            </div>
        </div>
    </div>
</header>




<article>
    <div class="container">
        <div class="row">

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                
                <!-- > 千里之行始于足下 -->
<h3 id="pandas数据处理分析与输出">Pandas数据处理、分析与输出</h3>
<p>前面我们已经学习了<code>Pandas</code> 的基础操作，本节开始数据处理与分析层，也就是 <code>Pandas</code> 的核心能力部分，需要掌握 <code>Pandas</code> 在数据整理、统计分析、分组计算、时间序列处理等方面的常用功能，学会完成从“原始数据”到“分析结果”的关键步骤。</p>
<ol>
<li>
<p><strong>数据清洗与预处理(Data Cleaning)</strong><br>
在实际的数据分析工作中，我们的原始数据并不完全按照我们需要的来呈现，而这就需要我们解决“脏数据”的问题，为后续分析打基础。在数据预处理部分主要包括：</p>
<ul>
<li>缺失值处理（data.info(),data.isna().sum(),fillna(),dropna()）</li>
<li>重复值处理(data.duplicated(),data.drop_duplicates())</li>
<li>数据类型转换(float→int,str→datetime,to_datetime()、to_numeric())<br>
<br/>
我们还是用上节课的例子进行讲解，数据内容如下表所示：</li>
</ul>
<pre tabindex="0"><code>站点名称	        时间	    SO2	    NO2	    NOx	    O3	    CO	    PM10    PM2.5
站点A	2021-05-01 01:00	ssss	21	21	74	0.3	62	35
站点A	2021-05-01 02:00	2	18	19	75	0.282	49	34
站点A	2021-05-01 03:00	5	34	35	54	0.347	50	36
站点A	2021-05-01 04:00	11	46	46	35	0.578	72	43
站点A	2021-05-01 05:00	13	57	58	22	0.68	78	44
站点A	2021-05-01 06:00	25	53	55	24	0.764	80	50
站点A	2021-05-01 07:00	18	43	52	31	0.85	75	47
站点A	2021-05-01 08:00	17	35	47	44	0.983	89	48
站点A	2021-05-01 09:00	24	34	48	55	0.752	85	51
站点A	2021-05-01 10:00	18	22	29	78	0.538	89	43
站点A	2021-05-01 11:00	7	13	15	102	0.461	65	24
站点A	2021-05-01 12:00	6	11	13	114	0.389	62	18
站点A	2021-05-01 13:00	6	14	16	118	0.484	69	24
站点A	2021-05-01 14:00	7	13	14	128	0.309	88	32
站点A	2021-05-01 15:00	7	11	12	140	0.303	93	35
站点A	2021-05-01 16:00	7	12	12	136	0.267	91	30
</code></pre> <br/>
<p><strong>(1)数据基本信息查看</strong><br>
首先我们采用pandas读取文件，读取完文件后用<code>data.info()</code>查看数据：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#39;/Users/gong/Documents/PKU/Courses/python_basic/python course_2025/常规小时数据.xlsx&#39;</span>
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_excel(file)
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>info()
</span></span></code></pre></div><p>读取数据完成后,显示数据的基本信息如下：</p>
<pre tabindex="0"><code>&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
RangeIndex: 574 entries, 0 to 573
Data columns (total 10 columns):
#   Column  Non-Null Count  Dtype  
---  ------  --------------  -----  
0   站点名称    574 non-null    object 
1   时间      574 non-null    object 
2   SO2     572 non-null    object 
3   NO      569 non-null    object 
4   NO2     569 non-null    float64
5   NOx     569 non-null    float64
6   O3      571 non-null    float64
7   CO      572 non-null    float64
8   PM10    567 non-null    float64
9   PM2.5   550 non-null    float64
dtypes: float64(6), object(4)
memory usage: 45.0+ KB
</code></pre><p>上面的信息包含数据有多少行(RangeIndex)，多少列(Data columns)，以及每列的数据情况，包含列明，每列的数据情况，以及每列的数据类型，其中object代表是字符串的文本数据，如果数据里有一条字符串，则改列都会被认为是字符串列。<br>
<br/>
具体数据信息如何，我们可以用上节课的<code>data.head()</code>看前面5行,<code>data.tail()</code>看最后面的5行,<code>data.shape</code>是看数据的行列数据,<code>data.dolumns()</code>是看数据的表头，<code>data.describe()</code>查看基本统计信息.<br>
值得注意的是<code>data.describe()</code>是对数据有一个简单的过滤功能的，因为如果是字符串的统计数据，则不会体现数据的统计状态，而是不同字符串出现的次数，这里它将含有字符串或者说没法计算的站点列、SO2和NO列给忽略了。</p>
<pre tabindex="0"><code>            NO2         NOx          O3   CO(mg/m3)        PM10       PM2.5
count  569.000000  569.000000  571.000000  572.000000  567.000000  550.000000
mean    24.200351   28.068541   92.350263    0.653462  151.576720   48.010909
std     13.173888   17.636506   41.937421    0.454901  137.185724   32.062324
min      6.000000    8.000000    1.000000    0.095000   31.000000   14.000000
25%     14.000000   16.000000   62.000000    0.389750   69.000000   30.000000
50%     20.000000   22.000000   92.000000    0.562000  105.000000   39.000000
75%     31.000000   35.000000  121.000000    0.782000  184.500000   54.000000
max     73.000000  121.000000  195.000000    4.322000  920.000000  223.000000
</code></pre> <br/>
<p><strong>(2)异常值处理</strong></p>
<p>上面的数据中，有两个常见的问题，就是空值和异常值，通常这两种情况是需要进行处理的，下面我们详细讲解。<br>
首先是我们需要对列名进行处理，当excel表列名无端多了个空格后，在excel表格中打开不显示，但是程序却无法识别，为防止我们无法精准筛选列名，我们通常需要去除列名两边的空格。如下所示：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">str</span>(c)<span style="color:#ff79c6">.</span>strip() <span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> df<span style="color:#ff79c6">.</span>columns]
</span></span></code></pre></div><p>这里的程序略微复杂，它表达的意思是在列表<code>[]</code>里的一个循环，循环后生成一个列表数据。<br>
<br/></p>
<p>接着我们需要去除字符串前后空格，并将 <code>&quot;NA&quot;、&quot;N/A&quot;</code> 转为 <code>NaN</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns:
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> data[c]<span style="color:#ff79c6">.</span>dtype <span style="color:#ff79c6">==</span> <span style="color:#8be9fd;font-style:italic">object</span>:
</span></span><span style="display:flex;"><span>    data[c] <span style="color:#ff79c6">=</span> data[c]<span style="color:#ff79c6">.</span>astype(<span style="color:#8be9fd;font-style:italic">str</span>)<span style="color:#ff79c6">.</span>str<span style="color:#ff79c6">.</span>strip()<span style="color:#ff79c6">.</span>replace({<span style="color:#f1fa8c">&#34;nan&#34;</span>: np<span style="color:#ff79c6">.</span>nan, <span style="color:#f1fa8c">&#34;NA&#34;</span>: np<span style="color:#ff79c6">.</span>nan, <span style="color:#f1fa8c">&#34;N/A&#34;</span>: np<span style="color:#ff79c6">.</span>nan})
</span></span></code></pre></div><p>通过遍历循环，把每列进行循环计算，每列中如果是<code>object</code>的格式，就删除该列数据两端的空格，并将<code>&quot;nan&quot;、&quot;NA&quot;、&quot;N/A&quot; </code>转为控制<code>np.nan</code>。注意<code>pandas</code>里面的空值是<code>np.nan</code>，它并不会直接识别<code>nan</code>，<code>nan</code>在读取的时候是一个字符串。当然我们数据给的字符串为ssss，实际使用中，简单替换就行。<br>
<br/></p>
<p>在处理完各种错误的字符串或者空值代表的数据后，我们需要处理空值，也即对空值进行填充，常见的填充包括用前后的数据填充或者差值数据填充。以下面的代码为例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4"># 检查缺失值情况</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(data<span style="color:#ff79c6">.</span>isna()<span style="color:#ff79c6">.</span>sum())
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 缺失值填充（以SO2为例）</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;SO2&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns:
</span></span><span style="display:flex;"><span>    data[<span style="color:#f1fa8c">&#34;SO2&#34;</span>] <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>to_numeric(data[<span style="color:#f1fa8c">&#34;SO2&#34;</span>], errors<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;coerce&#34;</span>)
</span></span><span style="display:flex;"><span>    data[<span style="color:#f1fa8c">&#34;SO2&#34;</span>]<span style="color:#ff79c6">.</span>fillna(data[<span style="color:#f1fa8c">&#34;SO2&#34;</span>]<span style="color:#ff79c6">.</span>mean(), inplace<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span></code></pre></div><p>上面的代码，首先通过<code>data.isna().sum()</code>查看总体的数据缺失情况，接着对SO2列进行数字化处理，然后将空值用SO2列的平均值进行填充，这里主要采用的<code>data.fillna()</code><br>
常见的缺失数据处理有:</p>
<table>
  <thead>
      <tr>
          <th>方法</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>dropna()</code></td>
          <td>删除含缺失值的行或列</td>
      </tr>
      <tr>
          <td><code>fillna(x)</code></td>
          <td>用指定值填充</td>
      </tr>
      <tr>
          <td><code>fillna(method='ffill')</code></td>
          <td>用前一个值填充</td>
      </tr>
      <tr>
          <td><code>fillna(method='bfill')</code></td>
          <td>用后一个值填充</td>
      </tr>
  </tbody>
</table>
<p>除了以上几种方法外，我们还可以用<code>scipy.intrepolate()</code>进行插值，通常用线性插值：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data1 <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>interpolate(method<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;linear&#39;</span>) 
</span></span></code></pre></div><p>当然除了线性插值，还能用<code>nearest’, ‘zero’, ‘slinear’, ‘quadratic’, ‘cubic’, ‘barycentric’</code>等方法，到这里，数据清洗工作基本完成。</p>
 <br/> 
</li>
<li>
<p><strong>数据常规统计</strong><br>
对于一个数据来讲，进行统计分析是常见的分析方法，因此我们对数据统计分析进行简单的讲解，当然也包括程序的描述性统计分析<code>data.describe()</code>，除此之外，常规统计有<code>data.mean(),data.median(),data.std(),data.min(),data.max(),data.quantile()</code>,也有唯一值与频率的统计<code>data.value_counts(),data.nunique()</code>等</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>sum(axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>) <span style="color:#6272a4">#0和1分别代表横向和纵向求和</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#f1fa8c">&#39;PM2.5&#39;</span>]<span style="color:#ff79c6">.</span>mean()
</span></span><span style="display:flex;"><span>data[<span style="color:#f1fa8c">&#39;PM2.5&#39;</span>]<span style="color:#ff79c6">.</span>quantile()
</span></span><span style="display:flex;"><span>data[<span style="color:#f1fa8c">&#39;站点名称&#39;</span>]<span style="color:#ff79c6">.</span>value_counts()
</span></span></code></pre></div> <br/>
<p>这里支持所有数据或者单列数据的计算，如果需要更近一步的组合筛选，那我们就需要用到python的一个灵魂函数<code>groupby</code>，它的作用是——<strong>把数据按某个（或多个）条件分组，然后对每组分别计算统计量</strong>，就像 <code>excel</code> 里的“分类汇总”。看如下示例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#计算每个城市的PM2.5平均值</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>groupby(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)[<span style="color:#f1fa8c">&#39;PM2.5&#39;</span>]<span style="color:#ff79c6">.</span>mean()
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#计算每个城市的PM2.5和O3平均值</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>groupby(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)[[<span style="color:#f1fa8c">&#39;PM2.5&#39;</span>,<span style="color:#f1fa8c">&#39;O3&#39;</span>]]<span style="color:#ff79c6">.</span>mean() 
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#使用 agg() 同时计算多个指标</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>groupby(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)[<span style="color:#f1fa8c">&#39;O3&#39;</span>]<span style="color:#ff79c6">.</span>agg([<span style="color:#f1fa8c">&#39;mean&#39;</span>,<span style="color:#f1fa8c">&#39;max&#39;</span>,<span style="color:#f1fa8c">&#39;std&#39;</span>])
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#groupby 的结果通常会带有“分组键”作为索引，如果想让它变回普通列，可以用下面的函数</span>
</span></span><span style="display:flex;"><span>result <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>groupby(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)[<span style="color:#f1fa8c">&#39;PM2.5&#39;</span>]<span style="color:#ff79c6">.</span>mean()<span style="color:#ff79c6">.</span>reset_index()
</span></span></code></pre></div><p>聚类后可接所有的常规统计函数<code>data.mean(),data.median(),data.std(),data.min(),data.max(),data.quantile()</code>。
<br/></p>
<p>pandas 也有数据透视表(Pivot Table)的功能，pivot_table() 可实现多维统计分析，非常适合生成月均、季度均等表格，具体如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;站点名称&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">and</span> <span style="color:#f1fa8c">&#34;PM2.5&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns :
</span></span><span style="display:flex;"><span>    pivot <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>pivot_table(data, values<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;PM2.5&#34;</span>, index<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;站点名称&#34;</span>, aggfunc<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;mean&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(pivot)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#如果列中有月的数据，可进行按月进行透视</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">if</span> <span style="color:#f1fa8c">&#34;站点名称&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">and</span> <span style="color:#f1fa8c">&#34;PM2.5&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">and</span> <span style="color:#f1fa8c">&#34;月份&#34;</span> <span style="color:#ff79c6">in</span> data<span style="color:#ff79c6">.</span>columns:
</span></span><span style="display:flex;"><span>    pivot <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>pivot_table(data, values<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;PM2.5&#34;</span>, index<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;站点名称&#34;</span>, columns<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;月份&#34;</span>, aggfunc<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;mean&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#8be9fd;font-style:italic">print</span>(pivot)
</span></span></code></pre></div> <br/>
</li>
<li>
<p><strong>时序数据分析</strong><br>
透视表按月功能是在月数据单独提供是比较容易使用，但是通常数据并不单独提供月的数据，而是时序数据，在时序处理中，python的时间是有单独的datetime格式的，支持我们对时间进行简单的操作：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">from</span> datetime <span style="color:#ff79c6">import</span> datetime 
</span></span><span style="display:flex;"><span>now <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>now() <span style="color:#6272a4">#获取当前时间</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(now)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">type</span>(now)) <span style="color:#6272a4">#时间的数据类型</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(now<span style="color:#ff79c6">.</span>hour) <span style="color:#6272a4">#显示当前时间的小时值</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#now.year,month,day</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>datetime(<span style="color:#bd93f9">2023</span>,<span style="color:#bd93f9">1</span>,<span style="color:#bd93f9">29</span>,<span style="color:#bd93f9">14</span>) <span style="color:#6272a4">#创建一个时间格式数据</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#时间格式支持直接加减</span>
</span></span><span style="display:flex;"><span>delta <span style="color:#ff79c6">=</span> datetime(<span style="color:#bd93f9">2022</span>,<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">13</span>,<span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">-</span>datetime(<span style="color:#bd93f9">2022</span>,<span style="color:#bd93f9">7</span>,<span style="color:#bd93f9">1</span>) 
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(delta)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#字符串格式转化为时间</span>
</span></span><span style="display:flex;"><span>right_now <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">&#39;2022-08-05&#39;</span> 
</span></span><span style="display:flex;"><span>now1 <span style="color:#ff79c6">=</span> datetime<span style="color:#ff79c6">.</span>strptime(right_now,<span style="color:#f1fa8c">&#39;%Y-%m-</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c">&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(now1)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(<span style="color:#8be9fd;font-style:italic">type</span>(now1))
</span></span></code></pre></div> <br/>
 由于有单独的时间格式，因此`python`的时间格式可以作为`dataframe`数据的指针，进而直接进行索引的筛选
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#修改时间列名，尽量多用英文</span>
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>rename(columns<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;时间&#39;</span>:<span style="color:#f1fa8c">&#39;Datetime&#39;</span>})
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#将index替换为时间列</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>index <span style="color:#ff79c6">=</span> data[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>]
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(data<span style="color:#ff79c6">.</span>index)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>data1 <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>loc[<span style="color:#f1fa8c">&#39;2021-05-10 08:00&#39;</span>] <span style="color:#6272a4">#时间筛选</span>
</span></span><span style="display:flex;"><span>data2 <span style="color:#ff79c6">=</span> data<span style="color:#ff79c6">.</span>loc[<span style="color:#f1fa8c">&#39;2021-05-04&#39;</span>:<span style="color:#f1fa8c">&#39;2021-05-06&#39;</span>] <span style="color:#6272a4">#时间段筛选</span>
</span></span><span style="display:flex;"><span>data3 <span style="color:#ff79c6">=</span> data[<span style="color:#f1fa8c">&#39;2021-05&#39;</span>] <span style="color:#6272a4">#支持按年、月、日进行筛选</span>
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(data1)
</span></span></code></pre></div><p>有时程序读取时间，由于有不同的时间格式，因此时间字符串并不会读取为时间列，这个时候需要采用<code>pd.to_datetime(data['时间列'],format = '')</code>进行转化,其中<code>format</code>格式要与输入数据完全一致，如<code>'2022-05-01 03:12:46'</code>需要匹配为<code>%Y-%m-%d %H:%M:%S</code>，不然就会报错。<br>
当然不提供格式程序会按照常见类型的进行识别，<code>Pandas</code> 会自动识别多种日期格式（如 -、/、中文日期等），<code>[&quot;2025-10-22 08:00:00&quot;, &quot;2025/10/22 09:30:00&quot;, &quot;2025年10月22日 10:00&quot;]</code>。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>time_str <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>Series([<span style="color:#f1fa8c">&#34;2025-10-22 08:00:00&#34;</span>, <span style="color:#f1fa8c">&#34;2025/10/22 09:30:00&#34;</span>, <span style="color:#f1fa8c">&#34;2025年10月22日 10:00&#34;</span>])
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 自动识别多种格式</span>
</span></span><span style="display:flex;"><span>time_parsed <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>to_datetime(time_str, errors<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;coerce&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(time_parsed)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#文件读取案例</span>
</span></span><span style="display:flex;"><span>data[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>]<span style="color:#ff79c6">=</span>pd<span style="color:#ff79c6">.</span>to_datetime(data[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>],<span style="color:#8be9fd;font-style:italic">format</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;%Y-%m-</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> %H&#34;</span>)
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>set_index(<span style="color:#f1fa8c">&#34;Datetime&#34;</span>, inplace<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>) <span style="color:#6272a4">#设置Datetime为index列</span>
</span></span></code></pre></div><p>当数据格式统一时，可以显式指定格式，加快解析速度并减少错误。</p>
 <br/>
<p>时间处理完成后呢，可以支持快速的数据计算，依托pd.resample()直接进行重采样,然后对年、月、日、小时、分钟进行统计分析，如求和、平均、标准差等。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>resample(<span style="color:#f1fa8c">&#39;D&#39;</span>)<span style="color:#ff79c6">.</span>mean()   <span style="color:#6272a4"># 按天取平均</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>resample(<span style="color:#f1fa8c">&#39;H&#39;</span>)<span style="color:#ff79c6">.</span>sum()    <span style="color:#6272a4"># 按小时求和</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>resample(<span style="color:#f1fa8c">&#39;H&#39;</span>)<span style="color:#ff79c6">.</span>sum()<span style="color:#ff79c6">.</span>round(<span style="color:#bd93f9">2</span>) <span style="color:#6272a4">#空值2位小数</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>resample(<span style="color:#f1fa8c">&#39;5min&#39;</span>)<span style="color:#ff79c6">.</span>std() <span style="color:#6272a4"># 按5分钟求平均</span>
</span></span></code></pre></div> <br/> 
<p>当然也方便快速提取对应的年、月、日信息，方便进行归类</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>index<span style="color:#ff79c6">.</span>year
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>index<span style="color:#ff79c6">.</span>month
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>index<span style="color:#ff79c6">.</span>hour
</span></span></code></pre></div> <br/>
<p>归类后就可以对数据进行筛选，以计算O3的日间24小时变化为例：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>hour <span style="color:#ff79c6">=</span> data[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>]<span style="color:#ff79c6">.</span>dt<span style="color:#ff79c6">.</span>hour
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(data<span style="color:#ff79c6">.</span>groupby(hour)<span style="color:#ff79c6">.</span>mean())
</span></span></code></pre></div> <br/>
<p>在时间序列分析中，我们常常需要计算“滑动平均”“滑动标准差”“滚动和”等指标用于<strong>平滑曲线</strong>、<strong>去除噪声</strong>、或<strong>分析变化趋势</strong>。  在 <code>Pandas</code> 中，这类操作可以用 <strong><code>pd.rolling()</code></strong> 方法轻松完成</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>DataFrame<span style="color:#ff79c6">.</span>rolling(window, min_periods<span style="color:#ff79c6">=</span><span style="color:#ff79c6">None</span>, center<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>)<span style="color:#ff79c6">.</span>函数()
</span></span></code></pre></div><p><code>pd.rolling()</code>用法说明如下：</p>
<table>
  <thead>
      <tr>
          <th>参数</th>
          <th>说明</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><code>window</code></td>
          <td>滑动窗口大小（可以是整数或时间间隔，如 <code>24</code>、<code>'7D'</code>）</td>
      </tr>
      <tr>
          <td><code>min_periods</code></td>
          <td>最少需要多少个有效值才计算结果</td>
      </tr>
      <tr>
          <td><code>center</code></td>
          <td>是否让窗口居中（默认靠右）</td>
      </tr>
      <tr>
          <td>常配合函数</td>
          <td><code>mean()</code>、<code>sum()</code>、<code>std()</code>、<code>max()</code>、<code>min()</code></td>
      </tr>
      <tr>
          <td><br/></td>
          <td></td>
      </tr>
  </tbody>
</table>
<p>在空气质量评价中，<strong>臭氧 8 小时滑动平均浓度（O₃-8h）</strong> 是非常重要的指标，它用于衡量持续暴露的臭氧水平，我们以此为例：</p>
<blockquote>
<p><strong>定义：</strong><br>
在任意连续 8 小时内，计算这 8 小时 O₃ 浓度的平均值，<br>
以反映该时段内的臭氧暴露强度。
依旧采用上面的数据</p></blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#读取文件数据</span>
</span></span><span style="display:flex;"><span>csv_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#39;/Users/gong/Documents/PKU/Courses/python_basic/python_course_data/csv/常规小时数据.csv&#39;</span> 
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(csv_file)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#处理列名，防止空格</span>
</span></span><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">=</span> [<span style="color:#8be9fd;font-style:italic">str</span>(c)<span style="color:#ff79c6">.</span>strip() <span style="color:#ff79c6">for</span> c <span style="color:#ff79c6">in</span> df<span style="color:#ff79c6">.</span>columns]
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#修改时间列名</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>rename(columns<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;时间&#39;</span>:<span style="color:#f1fa8c">&#39;Datetime&#39;</span>})
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#处理时间列格式</span>
</span></span><span style="display:flex;"><span>df[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>]<span style="color:#ff79c6">=</span>pd<span style="color:#ff79c6">.</span>to_datetime(df[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>],<span style="color:#8be9fd;font-style:italic">format</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#34;%Y-%m-</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> %H&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#因为有两个站点，需要每个站点单独进行</span>
</span></span><span style="display:flex;"><span>stations <span style="color:#ff79c6">=</span> df[<span style="color:#f1fa8c">&#39;站点名称&#39;</span>]<span style="color:#ff79c6">.</span>unique()
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> st <span style="color:#ff79c6">in</span> stations:
</span></span><span style="display:flex;"><span>    df_one <span style="color:#ff79c6">=</span> df[df[<span style="color:#f1fa8c">&#39;站点名称&#39;</span>]<span style="color:#ff79c6">==</span>st]
</span></span><span style="display:flex;"><span>    df_one<span style="color:#ff79c6">.</span>set_index(<span style="color:#f1fa8c">&#34;Datetime&#34;</span>, inplace<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>)
</span></span><span style="display:flex;"><span>    df_one[<span style="color:#f1fa8c">&#39;O3&#39;</span>] <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>to_numeric(df_one[<span style="color:#f1fa8c">&#39;O3&#39;</span>], errors<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;coerce&#39;</span>)
</span></span><span style="display:flex;"><span>    df_one[<span style="color:#f1fa8c">&#39;O3_8h&#39;</span>] <span style="color:#ff79c6">=</span> df_one[<span style="color:#f1fa8c">&#39;O3&#39;</span>]<span style="color:#ff79c6">.</span>rolling(window<span style="color:#ff79c6">=</span><span style="color:#bd93f9">8</span>, min_periods<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>)<span style="color:#ff79c6">.</span>mean()
</span></span></code></pre></div> <br/>
</li>
<li>
<p><strong>数据拼接</strong><br>
在对基础数据文件进行处理后，下一步就是学会把“多表、多文件、多指标”拼在一起，完成从原始表到“可分析的整合数据表”，这里我们会<code>concat/merge/join</code>三个方法，但通常而言，掌握<code>pd.concat</code>即可完成大多数的数据拼接，因此以<code>pd.concat</code>为主进行主要讲解。
拼接的主要场景有两个：</p>
<ul>
<li>纵向拼接（按行追加）：把多个月份/多个文件的同结构数据叠在一起</li>
<li>纵向拼接（按行追加）：把多个月份/多个文件的同结构数据叠在一起</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span> df1 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[<span style="color:#f1fa8c">&#39;a&#39;</span>, <span style="color:#bd93f9">1</span>], [<span style="color:#f1fa8c">&#39;b&#39;</span>, <span style="color:#bd93f9">2</span>]],
</span></span><span style="display:flex;"><span>                columns<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;letter&#39;</span>, <span style="color:#f1fa8c">&#39;number&#39;</span>])
</span></span><span style="display:flex;"><span> df2 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame([[<span style="color:#f1fa8c">&#39;c&#39;</span>, <span style="color:#bd93f9">3</span>], [<span style="color:#f1fa8c">&#39;d&#39;</span>, <span style="color:#bd93f9">4</span>]],
</span></span><span style="display:flex;"><span>                 columns<span style="color:#ff79c6">=</span>[<span style="color:#f1fa8c">&#39;letter&#39;</span>, <span style="color:#f1fa8c">&#39;number&#39;</span>])
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">print</span>(df1)
</span></span><span style="display:flex;"><span> <span style="color:#8be9fd;font-style:italic">print</span>(df2)
</span></span><span style="display:flex;"><span> pd<span style="color:#ff79c6">.</span>concat([df1, df2],axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>) <span style="color:#6272a4">#横向拼接</span>
</span></span><span style="display:flex;"><span> pd<span style="color:#ff79c6">.</span>concat([df1,df2],axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>) <span style="color:#6272a4">#纵向拼接</span>
</span></span></code></pre></div><p>当<code>concat</code>横向拼接采用索引进行对齐，相同列名或者index的索引进行拼接，列或者行不完全一致时，<code>concat</code>会做列并集，缺的列用 <code>NaN</code> 补齐，看下面的例子：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df1 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame(
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;A&#34;</span>: [<span style="color:#f1fa8c">&#34;A0&#34;</span>, <span style="color:#f1fa8c">&#34;A1&#34;</span>, <span style="color:#f1fa8c">&#34;A2&#34;</span>, <span style="color:#f1fa8c">&#34;A3&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;B&#34;</span>: [<span style="color:#f1fa8c">&#34;B0&#34;</span>, <span style="color:#f1fa8c">&#34;B1&#34;</span>, <span style="color:#f1fa8c">&#34;B2&#34;</span>, <span style="color:#f1fa8c">&#34;B3&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;C&#34;</span>: [<span style="color:#f1fa8c">&#34;C0&#34;</span>, <span style="color:#f1fa8c">&#34;C1&#34;</span>, <span style="color:#f1fa8c">&#34;C2&#34;</span>, <span style="color:#f1fa8c">&#34;C3&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;D&#34;</span>: [<span style="color:#f1fa8c">&#34;D0&#34;</span>, <span style="color:#f1fa8c">&#34;D1&#34;</span>, <span style="color:#f1fa8c">&#34;D2&#34;</span>, <span style="color:#f1fa8c">&#34;D3&#34;</span>],
</span></span><span style="display:flex;"><span>    },index<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">0</span>, <span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>],)
</span></span><span style="display:flex;"><span>df2 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame(
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;A&#34;</span>: [<span style="color:#f1fa8c">&#34;A4&#34;</span>, <span style="color:#f1fa8c">&#34;A5&#34;</span>, <span style="color:#f1fa8c">&#34;A6&#34;</span>, <span style="color:#f1fa8c">&#34;A7&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;B&#34;</span>: [<span style="color:#f1fa8c">&#34;B4&#34;</span>, <span style="color:#f1fa8c">&#34;B5&#34;</span>, <span style="color:#f1fa8c">&#34;B6&#34;</span>, <span style="color:#f1fa8c">&#34;B7&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;C&#34;</span>: [<span style="color:#f1fa8c">&#34;C4&#34;</span>, <span style="color:#f1fa8c">&#34;C5&#34;</span>, <span style="color:#f1fa8c">&#34;C6&#34;</span>, <span style="color:#f1fa8c">&#34;C7&#34;</span>],
</span></span><span style="display:flex;"><span>        <span style="color:#f1fa8c">&#34;E&#34;</span>: [<span style="color:#f1fa8c">&#34;D4&#34;</span>, <span style="color:#f1fa8c">&#34;D5&#34;</span>, <span style="color:#f1fa8c">&#34;D6&#34;</span>, <span style="color:#f1fa8c">&#34;D7&#34;</span>],
</span></span><span style="display:flex;"><span>    },index<span style="color:#ff79c6">=</span>[<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">4</span>, <span style="color:#bd93f9">5</span>],)
</span></span><span style="display:flex;"><span>c1 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>concat([df1,df2], axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">0</span>) <span style="color:#6272a4">#纵向拼接</span>
</span></span><span style="display:flex;"><span>c2 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>concat([df1,df2], axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>) <span style="color:#6272a4">#纵向拼接</span>
</span></span></code></pre></div><p>为了不产生<code>NaN</code>补齐，则需要把行或者列的名称对准为完全一致后进行拼接。
下面讲一个实际应用案例，计算多个站点的平均值，并生成一个新的<code>dataframe</code>，方便后续操作。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#导入依赖库文件</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#读取文件内容</span>
</span></span><span style="display:flex;"><span>csv_file <span style="color:#ff79c6">=</span> <span style="color:#f1fa8c">r</span><span style="color:#f1fa8c">&#39;/Users/gong/Documents/PKU/Courses/python_basic/python_course_data/csv/常规小时数据.csv&#39;</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>read_csv(csv_file)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#更换列名并处理时间格式</span>
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>rename(columns<span style="color:#ff79c6">=</span>{<span style="color:#f1fa8c">&#39;站点名称&#39;</span>:<span style="color:#f1fa8c">&#39;Stations&#39;</span>,<span style="color:#f1fa8c">&#39;时间&#39;</span>:<span style="color:#f1fa8c">&#39;Datetime&#39;</span>})
</span></span><span style="display:flex;"><span>df[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>] <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>to_datetime(df[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>],<span style="color:#8be9fd;font-style:italic">format</span><span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;%Y-%m-</span><span style="color:#f1fa8c">%d</span><span style="color:#f1fa8c"> %H&#39;</span>)
</span></span><span style="display:flex;"><span>df<span style="color:#ff79c6">.</span>index <span style="color:#ff79c6">=</span> df[<span style="color:#f1fa8c">&#39;Datetime&#39;</span>]
</span></span><span style="display:flex;"><span>df <span style="color:#ff79c6">=</span> df<span style="color:#ff79c6">.</span>drop([<span style="color:#f1fa8c">&#39;Datetime&#39;</span>],axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#查找站点</span>
</span></span><span style="display:flex;"><span>columns <span style="color:#ff79c6">=</span> df[<span style="color:#f1fa8c">&#39;Stations&#39;</span>]<span style="color:#ff79c6">.</span>tolist()
</span></span><span style="display:flex;"><span>columns_name <span style="color:#ff79c6">=</span> [<span style="color:#ff79c6">*</span><span style="color:#8be9fd;font-style:italic">set</span>(columns)]
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#新建空白的dataframe</span>
</span></span><span style="display:flex;"><span>df_all_avg <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame()
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#计算所有站点的平均值并保存</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">for</span> n <span style="color:#ff79c6">in</span> columns_name:
</span></span><span style="display:flex;"><span>    df_n <span style="color:#ff79c6">=</span> df[df[<span style="color:#f1fa8c">&#39;Stations&#39;</span>]<span style="color:#ff79c6">==</span>n] <span style="color:#6272a4">#筛选站点</span>
</span></span><span style="display:flex;"><span>    df_avg <span style="color:#ff79c6">=</span> df_n<span style="color:#ff79c6">.</span>mean(numeric_only<span style="color:#ff79c6">=</span><span style="color:#ff79c6">True</span>) <span style="color:#6272a4">#计算单个站点的平均值</span>
</span></span><span style="display:flex;"><span>    df_all_avg <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>concat([df_all_avg,df_avg],axis<span style="color:#ff79c6">=</span><span style="color:#bd93f9">1</span>) <span style="color:#6272a4">#concat</span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#修改新数据的列名</span>
</span></span><span style="display:flex;"><span>df_all_avg<span style="color:#ff79c6">.</span>columns <span style="color:#ff79c6">=</span> columns_name
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(df_all_avg)
</span></span></code></pre></div> <br/>
<p>至于pd.merge()主要是两个表的左右拼接，不能用于上下表的拼接，根据列名进行筛选，具体用法<code>pd.merge(left, right, on=['站点名称','时间'], how='inner')</code>，how: inner（交集）、left（保留左表全部）、right、outer（并集），on: 共同的键（列名相同）
示例如下：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>df1 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame({<span style="color:#f1fa8c">&#39;lkey&#39;</span>: [<span style="color:#f1fa8c">&#39;foo&#39;</span>, <span style="color:#f1fa8c">&#39;bar&#39;</span>, <span style="color:#f1fa8c">&#39;baz&#39;</span>, <span style="color:#f1fa8c">&#39;foo&#39;</span>],
</span></span><span style="display:flex;"><span>                <span style="color:#f1fa8c">&#39;value&#39;</span>: [<span style="color:#bd93f9">1</span>, <span style="color:#bd93f9">2</span>, <span style="color:#bd93f9">3</span>, <span style="color:#bd93f9">5</span>]})
</span></span><span style="display:flex;"><span>df2 <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame({<span style="color:#f1fa8c">&#39;rkey&#39;</span>: [<span style="color:#f1fa8c">&#39;foo&#39;</span>, <span style="color:#f1fa8c">&#39;bar&#39;</span>, <span style="color:#f1fa8c">&#39;baz&#39;</span>, <span style="color:#f1fa8c">&#39;foo&#39;</span>],
</span></span><span style="display:flex;"><span>                    <span style="color:#f1fa8c">&#39;value&#39;</span>: [<span style="color:#bd93f9">5</span>, <span style="color:#bd93f9">6</span>, <span style="color:#bd93f9">7</span>, <span style="color:#bd93f9">8</span>]})
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(df1)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(df2)
</span></span><span style="display:flex;"><span>pd<span style="color:#ff79c6">.</span>merge(df1,df2)
</span></span><span style="display:flex;"><span>pd<span style="color:#ff79c6">.</span>merge(df1,df2,how<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;right&#39;</span>) <span style="color:#6272a4">##inner,left,right,outer</span>
</span></span><span style="display:flex;"><span>df1<span style="color:#ff79c6">.</span>merge(df2, left_on<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;lkey&#39;</span>, right_on<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;rkey&#39;</span>)
</span></span></code></pre></div> <br/>
<p>pd.join()是两个表的上下拼接，主要根据index进行筛选，具体用法为<code>pd.join(other, on=None, how='left', lsuffix='', rsuffix='', sort=False)</code>，other是要连接的另一个 DataFrame，on用于连接的列（若两表都已设索引，可不写），how连接方式：&rsquo;left&rsquo;、&lsquo;right&rsquo;、&lsquo;inner&rsquo;、&lsquo;outer&rsquo;，lsuffix / rsuffix:重复列名时的后缀</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 污染物表</span>
</span></span><span style="display:flex;"><span>df_pollution <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;站点名称&#39;</span>: [<span style="color:#f1fa8c">&#39;A&#39;</span>,<span style="color:#f1fa8c">&#39;B&#39;</span>,<span style="color:#f1fa8c">&#39;C&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;O3&#39;</span>: [<span style="color:#bd93f9">80</span>, <span style="color:#bd93f9">90</span>, <span style="color:#bd93f9">100</span>]
</span></span><span style="display:flex;"><span>})<span style="color:#ff79c6">.</span>set_index(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 气象表</span>
</span></span><span style="display:flex;"><span>df_meteo <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;站点名称&#39;</span>: [<span style="color:#f1fa8c">&#39;A&#39;</span>,<span style="color:#f1fa8c">&#39;B&#39;</span>,<span style="color:#f1fa8c">&#39;C&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;温度&#39;</span>: [<span style="color:#bd93f9">25</span>, <span style="color:#bd93f9">26</span>, <span style="color:#bd93f9">27</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;湿度&#39;</span>: [<span style="color:#bd93f9">60</span>, <span style="color:#bd93f9">55</span>, <span style="color:#bd93f9">50</span>]
</span></span><span style="display:flex;"><span>})<span style="color:#ff79c6">.</span>set_index(<span style="color:#f1fa8c">&#39;站点名称&#39;</span>)
</span></span><span style="display:flex;"><span>df_joined <span style="color:#ff79c6">=</span> df_pollution<span style="color:#ff79c6">.</span>join(df_meteo, how<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;inner&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#8be9fd;font-style:italic">print</span>(df_joined)
</span></span></code></pre></div><p>详细的方法比较可以看pandas官网提供的示例说明<a href="https://pandas.pydata.org/docs/user_guide/merging.html">Merge, join, concat比较</a></p>
</li>
<li>
<p><strong>输出保存</strong><br>
在得到想要的数据之后，我们可以把数据进行输出保存，无论是结果分析、报告生成，还是中间数据保存，掌握DataFrame 的输出是必不可少的技能。<strong>初学者建议多输出数据进行简单验证</strong>，确保数据计算无误，再进行下一步操作，如画图分析。<br>
如何把<code>dataframe</code>中处理好的数据导出到不同格式文件中，<code>pandas</code>提供了非常便利的方法，常见的有<code>to_csv()</code>、<code>to_excel()</code>、<code>to_json()</code> 等常用方法。<br>
<strong>(1)保存为csv格式</strong><br>
csv是科学计算中常见的数据保存方法，它是以逗号分隔符进行存储的数据，我们先介绍保存到csv格式。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#ff79c6">import</span> pandas <span style="color:#ff79c6">as</span> pd
</span></span><span style="display:flex;"><span><span style="color:#6272a4"># 构造示例数据</span>
</span></span><span style="display:flex;"><span>data <span style="color:#ff79c6">=</span> pd<span style="color:#ff79c6">.</span>DataFrame({
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;站点名称&#39;</span>: [<span style="color:#f1fa8c">&#39;A&#39;</span>, <span style="color:#f1fa8c">&#39;B&#39;</span>, <span style="color:#f1fa8c">&#39;C&#39;</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;O3&#39;</span>: [<span style="color:#bd93f9">80</span>, <span style="color:#bd93f9">90</span>, <span style="color:#bd93f9">100</span>],
</span></span><span style="display:flex;"><span>    <span style="color:#f1fa8c">&#39;温度&#39;</span>: [<span style="color:#bd93f9">25.5</span>, <span style="color:#bd93f9">26.0</span>, <span style="color:#bd93f9">27.3</span>]
</span></span><span style="display:flex;"><span>})
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#保存到当前目录下的&#39;output.csv&#39;文件中</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>to_csv(<span style="color:#f1fa8c">&#39;output.csv&#39;</span>, index<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, encoding<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;utf-8-sig&#39;</span>) 
</span></span></code></pre></div><p>上述csv保存代码中，<code>index=False</code>:不导出行索引,<code>encoding='utf-8-sig'</code>:解决中文乱码,如果要控制小数位数可以采用<code>float_format='%.2f'</code><br>
<strong>(2)保存为excel格式</strong><br>
excel是办公分析最常用的格式，支持多工作表写入，继续以上述代码为例，但如果需要写入到多个表，则需要重复写入，通过控制<code>sheet_name</code>来实现。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#6272a4">#写入单个表</span>
</span></span><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>to_excel(<span style="color:#f1fa8c">&#39;output.xlsx&#39;</span>, index<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, sheet_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;Sheet1&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#6272a4">#写入多个表</span>
</span></span><span style="display:flex;"><span><span style="color:#ff79c6">with</span> pd<span style="color:#ff79c6">.</span>ExcelWriter(<span style="color:#f1fa8c">&#39;multi_sheet.xlsx&#39;</span>, engine<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;xlsxwriter&#39;</span>) <span style="color:#ff79c6">as</span> writer:
</span></span><span style="display:flex;"><span>    data<span style="color:#ff79c6">.</span>to_excel(writer, index<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, sheet_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;污染物&#39;</span>)
</span></span><span style="display:flex;"><span>    data<span style="color:#ff79c6">.</span>describe()<span style="color:#ff79c6">.</span>to_excel(writer, sheet_name<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;统计信息&#39;</span>)
</span></span></code></pre></div><p><strong>(3)保存为json格式</strong><br>
JSON格式是网页或接口交互的重要类型，在科学计算中使用较少，这里简单介绍。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span>data<span style="color:#ff79c6">.</span>to_json(<span style="color:#f1fa8c">&#39;data.json&#39;</span>, orient<span style="color:#ff79c6">=</span><span style="color:#f1fa8c">&#39;records&#39;</span>, force_ascii<span style="color:#ff79c6">=</span><span style="color:#ff79c6">False</span>, indent<span style="color:#ff79c6">=</span><span style="color:#bd93f9">2</span>)
</span></span></code></pre></div><p>上述输出中，orient=&lsquo;records&rsquo;：每行是一个字典（推荐），force_ascii=False：保留中文，indent=2：美化输出<br>
<strong>(4)保存为其它格式</strong><br>
其它的如Pickle格式(Python的序列化格式，保存速度快，适合中间结果存储)、SQL数据库表格式(SQLite、MySQL等数据库互通)在有需要的时候自行学习。</p>
<p><strong>小练习</strong></p>
<blockquote>
</blockquote>
<ol>
<li>read file as a dataframe</li>
<li>rename columns(站点名称，时间和CO(mg/m3))==&gt;(station,datetime,CO)</li>
<li>output single station data</li>
<li>cal daily average single stations</li>
<li>cal day average all stations together</li>
<li>cal 05-08 houly average</li>
<li>output above results as a file</li>
</ol>
<blockquote>
</blockquote>
<h2 id="下载练习">下载练习</h2>
<p>如果你需要一个练习，可以尝试下载后执行练习，<a href="/downloads/4_pandas_deal_with_file.zip">pandas_advance.ipynb</a>。</p>
</li>
</ol>


                

                

                
<script src="https://giscus.app/client.js"
        data-repo="pianist1900/pianist1900.github.io"
        data-repo-id="R_kgDOPmSUaw"
        data-category="General"
        data-category-id="DIC_kwDOPmSUa84CvTsQ"
        data-mapping="pathname"
        data-reactions-enabled="1"
        data-emit-metadata="0"
        data-theme="light"
        data-lang="zh-CN"
        crossorigin="anonymous"
        async>
</script>





            </div>

            
            
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
            

            
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                
                

                
                
            </div>
        </div>
    </div>
</article>




<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <ul class="list-inline text-center">
                    
                    <li>
                        <a href="mailto:2506790078@pku.edu.cn">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		           
                    
                    
                    
                    

		            
                    
                    <li>
                        <a target="_blank" href="/img/wechat-friend-invate.png">
                            <span class="fa-stack fa-lg">
                                <i class="fas fa-circle fa-stack-2x"></i>
                                <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                            </span>
                        </a>
                    </li>
		            
                    
                    
                    
                    
                    
                    
                    
                    
                    
                    
            
            
            
           
             </ul>
		<p class="copyright text-muted">
                    Copyright &copy; 龚说龚有理 2025
                    
                </p>
            </div>
        </div>
    </div>
</footer>




<script>
    function loadAsync(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>






<script>
    
    if($('#tag_cloud').length !== 0){
        loadAsync("/js/jquery.tagcloud.js",function(){
            $.fn.tagcloud.defaults = {
                
                color: {start: '#bbbbee', end: '#0085a1'},
            };
            $('#tag_cloud a').tagcloud();
        })
    }
</script>


<script>
    loadAsync("https://cdn.jsdelivr.net/npm/fastclick@1.0.6/lib/fastclick.min.js", function(){
        var $nav = document.querySelector("nav");
        if($nav) FastClick.attach($nav);
    })
</script>






<script type="text/javascript">
    function generateCatalog(selector) {

        
        
        
        
            _containerSelector = 'div.post-container'
        

        
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        
        $(selector).html('')

        
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow" title="' + t + '">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    


    loadAsync("\/js\/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>






</body>
</html>
